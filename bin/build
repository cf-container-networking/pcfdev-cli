#!/bin/bash

set -ex

pcfdev_cli_path=$(cd `dirname $0` && cd .. && pwd)
if [[ "$1" == "test" ]]
then
  vm_name="pcfdev-test2"
  release_id="1622"
  product_file_id="5657"
  md5="029b97e79d21a56dd820be8dab5ce0ee"
  ova_version="0"
else
  metadata=$(aws s3 cp s3://pcfdev/ci/pivnet-file-metadata -)
  vm_name=pcfdev-$(echo "$metadata" | jq -r .version)
  release_id=$(echo "$metadata" | jq -r .release_id)
  product_file_id=$(echo "$metadata" | jq -r .id)
  md5=$(echo "$metadata" | jq -r .md5)
  ova_version=$(echo "$metadata" | jq -r .version | tr -d v)
fi

pushd "$pcfdev_cli_path" >/dev/null
  go build \
    -ldflags \
    "-X main.buildVersion=0.0.0
     -X main.buildSHA=$(git rev-parse --short HEAD)
     -X main.ovaBuildVersion=${ova_version}
     -X main.vmName=${vm_name}
     -X main.releaseId=${release_id}
     -X main.productFileId=${product_file_id}
     -X main.md5=${md5}"
popd >/dev/null
