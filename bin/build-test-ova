#!/bin/bash -e

dir=$( cd $( dirname "${BASH_SOURCE[0]}" ) && cd ../assets && pwd )

eval $(~/Dropbox/export-pivnet-aws)

set -x

pushd $dir >/dev/null
  GOOS=linux go build fake_pcfdev_server.go
  GOOS=linux go build fake_api.go
  packer build -force pcfdev-test.json
  aws s3 cp $dir/output-virtualbox-iso/pcfdev-test.ova s3://pivotalnetwork/product_files/pcfdev/pcfdev-test.ova
  md5=$(md5 $dir/output-virtualbox-iso/pcfdev-test.ova | cut -d ' ' -f 4)
  curl \
    -X PATCH \
    -H "Authorization: Token $PIVNET_TOKEN" \
    -d "{\"product_file\":{\"md5\":\"${md5}\"}}" \
    https://network.pivotal.io/api/v2/products/pcfdev/product_files/5689
  echo "MD5: $md5"
  if [[ -n $INTEGRATION_TEST_OVA_HOME ]]; then
    cp output-virtualbox-iso/pcfdev-test.ova $INTEGRATION_TEST_OVA_HOME/ova
  fi
popd >/dev/null
